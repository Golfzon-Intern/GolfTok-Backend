<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.golfzon.golftok.mapper.CommentMapper">

	<resultMap id="usersResult" type="com.golfzon.golftok.model.TokUsers">
		<id property="userId" column="user_id"/>
		<result property="userName" column="user_name" />
		<result property="userNickname" column="user_nickname" />
		<result property="userPassword" column="user_password" />
		<result property="userIcon" column="user_icon" />
		<result property="friendCount" column="friend_count" />
		<result property="introductionMessage" column="introduction_message" />
		<result property="accountAccess" column="account_access" />
		<result property="birthDate" column="birth_date" />
	</resultMap>

	<resultMap id="postsResult" type="com.golfzon.golftok.model.TokPosts">
		<id property="postId" column="post_id"/>
		<result property="userId" column="user_id" />
		<result property="postContent" column="post_content" />
		<result property="videoRoot" column="video_root" />
		<result property="uploadDate" column="upload_date" />
		<result property="postAccess" column="post_access" />
		<result property="likeCount" column="like_count" />
		<result property="commentCount" column="comment_count" />
		<result property="viewCount" column="view_count" />
		<result property="locations" column="locations" />
	</resultMap>

	<resultMap id="commentsResult" type="com.golfzon.golftok.model.Comments">
		<id property="commentId" column="comment_id"/>
		<result property="postId" column="post_id" />
		<result property="userId" column="user_id" />
		<result property="commentText" column="comment_text" />
		<result property="uploadDate" column="upload_date" />
		<result property="likeCount" column="like_count" />
		<result property="commentGroup" column="comment_group" />
		<result property="groupOrder" column="group_order" />
		<result property="groupLayer" column="group_layer" />
	</resultMap>

	<!-- postId에 해당하는 모든 댓글 가져오기 -->
	<select id="getAllComments" parameterType="int" resultMap="commentsResult">
		select * from comments where post_id=#{postId}
	</select>
		
	<!-- 댓글 작성 -->
	<insert id="inputComment" parameterType="HashMap">
		<selectKey resultType="integer" keyProperty="commentId" order="BEFORE">
			select MAX(comment_id)+1 from comments
		</selectKey>
		insert into comments values
			(#{commentId},#{postId},#{userId},#{commentText},getdate(),0,
			<if test="commentGroup==0">#{commentId}</if><if test="commentGroup!=0">#{commentGroup}</if>,
			#{groupOrder},#{groupLayer})
	</insert>

	<!-- commentGroup의 댓글 총 개수 구하기 -->
	<select id="getCommentCount" parameterType="String" resultType="int">
		select count(*) from comments
		where comment_group=#{commentGroup}
	</select>
	
	<!-- 게시글 수정 -->
	<update id="editPost" parameterType="HashMap">
		update tok_posts
		set post_content=#{postContent}, video_root=#{videoRoot}, locations=#{locations}, post_access=#{postAccess}
		where post_id=#{postId}
	</update>
	
	<!-- 임시로 넣었던 groupOrder 다시 맞게 수정 -->
	<update id="updateGroupOrder" parameterType="String">
		update comments
		set group_order=#{groupOrder}
		where group_order='-1'
	</update>
	
</mapper>